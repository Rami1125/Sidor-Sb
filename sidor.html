<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>. 住 专 </title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #e0e5ec 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Glassmorphism styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .glass-input, .glass-select, .glass-textarea {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            padding: 10px 15px;
            color: #333;
            transition: all 0.2s ease-in-out;
        }

        .glass-input:focus, .glass-select:focus, .glass-textarea:focus {
            outline: none;
            border-color: rgba(0, 123, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
            background: rgba(255, 255, 255, 0.6);
        }

        .glass-button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .glass-button:hover {
            background: linear-gradient(135deg, #0056b3, #003d80);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .glass-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.1);
        }

        /* Nav Bar */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 -4px 6px rgba(0, 0, 0, 0.05);
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #555;
            font-size: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .nav-item:hover {
            color: #007bff;
            transform: translateY(-2px);
        }

        .nav-item.active {
            color: #007bff;
            font-weight: 600;
        }

        .nav-item i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        /* Order Form Progress Bar */
        .progress-container {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            height: 8px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #007bff, #00c6ff);
            border-radius: 10px;
            transition: width 0.4s ease-in-out;
        }

        /* Custom Scrollbar for desktop view */
        .desktop-content::-webkit-scrollbar {
            width: 8px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .desktop-content::-webkit-scrollbar-thumb {
            background-color: rgba(0, 123, 255, 0.5);
            border-radius: 10px;
        }

        .desktop-content::-webkit-scrollbar-thumb:hover {
            background-color: rgba(0, 123, 255, 0.7);
        }

        /* Highlight button effect */
        .highlight-button {
            position: relative;
            overflow: hidden;
        }

        .highlight-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -75%;
            width: 50%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            transform: skewX(-20deg);
            transition: all 0.7s ease;
        }

        .highlight-button:hover::before {
            left: 125%;
        }

        /* Tooltip style */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        /* Desktop layout for Department interface */
        @media (min-width: 768px) {
            .desktop-layout {
                display: grid;
                grid-template-columns: 1fr 3fr; /* Sidebar and main content */
                gap: 20px;
                padding: 20px;
                max-width: 1400px;
                margin: auto;
            }
            .desktop-sidebar {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 20px;
                height: calc(100vh - 40px);
                overflow-y: auto;
            }
            .desktop-content {
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border-radius: 15px;
                padding: 20px;
                height: calc(100vh - 40px);
                overflow-y: auto;
            }
            .bottom-nav {
                display: none; /* Hide bottom nav on desktop for department interface */
            }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Message Box Element -->
    <div id="messageBoxOverlay" class="message-box-overlay hidden"></div>
    <div id="messageBox" class="message-box hidden">
        <p id="messageBoxText" class="mb-4 text-lg"></p>
        <button id="messageBoxCloseBtn" class="glass-button px-6 py-2">砖专</button>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="flex flex-col items-center justify-center flex-grow p-4">
        <div class="glass-card p-8 md:p-10 w-full max-w-md text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-6 text-gray-800">转专转 . 住</h1>
            <img id="profileImage" src="https://placehold.co/100x100/A0C4FF/0A2342?text=驻专驻" alt="转转 驻专驻" class="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-2 border-white shadow-lg">
            <div class="mb-4">
                <input type="text" id="loginPhone" placeholder="驻 (砖 砖转砖)" class="glass-input w-full">
            </div>
            <div class="mb-6">
                <input type="password" id="loginPassword" placeholder="住住" class="glass-input w-full">
            </div>
            <button id="loginButton" class="glass-button w-full">转专</button>
            <p id="loginError" class="text-red-500 mt-4 hidden">砖 砖转砖  住住 砖.</p>
        </div>
    </div>

    <!-- Main App Content (Customer & Department Interfaces) -->
    <div id="appContent" class="flex-grow hidden">
        <!-- Customer Interface -->
        <div id="customerInterface" class="flex flex-col flex-grow w-full max-w-xl mx-auto p-4 pb-20">
            <h2 id="customerGreeting" class="text-2xl font-bold mb-4 text-center text-gray-800">砖, [砖 拽]</h2>

            <!-- New Order Button (always visible) -->
            <button id="newOrderButton" class="glass-button highlight-button px-6 py-3 mb-4 flex items-center justify-center text-lg">
                <i class="fas fa-plus-circle ml-2"></i> /驻 砖
            </button>

            <!-- Home Page -->
            <div id="customerHome" class="page active">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">转 砖</h3>
                <div id="customerOrdersList" class="space-y-4">
                    <!-- Orders will be loaded here -->
                    <p class="text-center text-gray-500">注 转...</p>
                </div>
                <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">驻转 砖</h3>
                <div id="customerChatList" class="space-y-4">
                    <!-- Chat inquiries will be loaded here -->
                    <p class="text-center text-gray-500">注 驻转...</p>
                </div>
            </div>

            <!-- New Order Form (hidden by default) -->
            <div id="newOrderFormPage" class="page hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-700">驻住 /驻 砖</h3>
                <div class="progress-container">
                    <div id="orderProgressBar" class="progress-bar"></div>
                </div>
                <form id="orderForm" class="glass-card p-6 space-y-4">
                    <!-- Step 1: Choose Action Type -->
                    <div id="formStep1" class="form-step">
                        <label for="orderType" class="block text-gray-700 font-medium mb-2">专 住 驻注:</label>
                        <select id="orderType" class="glass-select w-full" required>
                            <option value="">专...</option>
                            <option value="爪">爪转 </option>
                            <option value="驻">驻转 </option>
                            <option value="住祝 住祝">住祝 住祝</option>
                            <option value="转 祝">转 祝</option>
                            <option value="驻专拽 转">驻专拽 转</option>
                            <option value="砖 注 注 住驻拽">砖 注 注 住驻拽</option>
                            <option value="专">专</option>
                        </select>
                        <div class="flex justify-between mt-6">
                            <button type="button" id="nextStep1" class="glass-button"></button>
                        </div>
                    </div>

                    <!-- Step 2: Delivery Details & Items -->
                    <div id="formStep2" class="form-step hidden">
                        <label for="deliveryAddress" class="block text-gray-700 font-medium mb-2">转转 住驻拽:</label>
                        <input type="text" id="deliveryAddress" class="glass-input w-full mb-4" placeholder="专, 住驻专 转, 注专" required>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="deliveryDate" class="block text-gray-700 font-medium mb-2">转专 住驻拽:</label>
                                <input type="date" id="deliveryDate" class="glass-input w-full" required>
                            </div>
                            <div>
                                <label for="deliveryTime" class="block text-gray-700 font-medium mb-2">砖注转 住驻拽:</label>
                                <input type="text" id="deliveryTime" class="glass-input w-full" placeholder=": 08:00-12:00" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="contactPerson" class="block text-gray-700 font-medium mb-2">砖 拽砖专 转专:</label>
                                <input type="text" id="contactPerson" class="glass-input w-full" placeholder="砖 砖 拽砖专" required>
                            </div>
                            <div>
                                <label for="contactPhone" class="block text-gray-700 font-medium mb-2">驻 砖 拽砖专:</label>
                                <input type="tel" id="contactPhone" class="glass-input w-full" placeholder="住驻专 驻" required>
                            </div>
                        </div>

                        <label for="handlingMethod" class="block text-gray-700 font-medium mb-2">专 驻:</label>
                        <select id="handlingMethod" class="glass-select w-full mb-4" required>
                            <option value="">专...</option>
                            <option value=""></option>
                            <option value="住祝 住祝">住祝 住祝</option>
                        </select>

                        <div id="branchSelection" class="mb-4 hidden">
                            <label for="branch" class="block text-gray-700 font-medium mb-2">专 住祝:</label>
                            <select id="branch" class="glass-select w-full">
                                <option value="">专 住祝</option>
                                <option value="转">转</option>
                                <option value="专砖">专砖</option>
                            </select>
                        </div>

                        <div id="itemsSection">
                            <h4 class="text-lg font-semibold mb-2 text-gray-700">驻专 :</h4>
                            <div id="orderItemsContainer" class="space-y-3 mb-4">
                                <!-- Item rows will be dynamically added here -->
                            </div>
                            <button type="button" id="addItemButton" class="glass-button text-sm px-4 py-2 flex items-center">
                                <i class="fas fa-plus mr-2"></i>住祝 驻专
                            </button>
                        </div>

                        <div class="flex justify-between mt-6">
                            <button type="button" id="prevStep2" class="glass-button-secondary">拽</button>
                            <button type="button" id="nextStep2" class="glass-button"></button>
                        </div>
                    </div>

                    <!-- Step 3: Confirmation and Submit -->
                    <div id="formStep3" class="form-step hidden">
                        <h4 class="text-lg font-semibold mb-4 text-gray-700">住 :</h4>
                        <div id="orderSummary" class="glass-card p-4 mb-6 text-sm">
                            <!-- Order summary will be displayed here -->
                        </div>
                        <div class="flex justify-between mt-6">
                            <button type="button" id="prevStep3" class="glass-button-secondary">拽</button>
                            <button type="submit" id="submitOrder" class="glass-button">砖  住驻</button>
                        </div>
                    </div>
                </form>

                <!-- Calculator Popup -->
                <div id="calculatorPopup" class="glass-card message-box hidden p-6 space-y-4">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">砖</h3>
                    <div>
                        <label for="calcType" class="block text-gray-700 font-medium mb-2">专 砖:</label>
                        <select id="calcType" class="glass-select w-full">
                            <option value="drywall">砖 "专 转 住</option>
                            <option value="adhesive">转 住 拽</option>
                            <option value="gravel">砖 爪抓/住住</option>
                        </select>
                    </div>

                    <div id="drywallCalc" class="calc-section space-y-2">
                        <label for="drywallLength" class="block text-gray-700 font-medium">专 (专):</label>
                        <input type="number" id="drywallLength" class="glass-input w-full" placeholder="专">
                        <label for="drywallWidth" class="block text-gray-700 font-medium">专 (专):</label>
                        <input type="number" id="drywallWidth" class="glass-input w-full" placeholder="专">
                        <p>转爪: <span id="drywallResult" class="font-semibold">0</span> "专</p>
                    </div>

                    <div id="adhesiveCalc" class="calc-section space-y-2 hidden">
                        <label for="adhesiveArea" class="block text-gray-700 font-medium">砖 住 ("专):</label>
                        <input type="number" id="adhesiveArea" class="glass-input w-full" placeholder="砖">
                        <label for="adhesiveCoverage" class="block text-gray-700 font-medium">住  ("专/):</label>
                        <input type="number" id="adhesiveCoverage" class="glass-input w-full" placeholder=": 10">
                        <p>住驻专  专砖: <span id="adhesiveResult" class="font-semibold">0</span></p>
                    </div>

                    <div id="gravelCalc" class="calc-section space-y-2 hidden">
                        <label for="gravelLength" class="block text-gray-700 font-medium">专 (专):</label>
                        <input type="number" id="gravelLength" class="glass-input w-full" placeholder="专">
                        <label for="gravelWidth" class="block text-gray-700 font-medium">专 (专):</label>
                        <input type="number" id="gravelWidth" class="glass-input w-full" placeholder="专">
                        <label for="gravelHeight" class="block text-gray-700 font-medium"> (专):</label>
                        <input type="number" id="gravelHeight" class="glass-input w-full" placeholder="">
                        <p>驻 专砖: <span id="gravelVolumeResult" class="font-semibold">0</span> 拽</p>
                        <p>转 砖拽 (爪 拽 砖拽): <span id="gravelBagsResult" class="font-semibold">0</span> 砖拽</p>
                    </div>
                    <button id="closeCalculator" class="glass-button w-full mt-4">住专</button>
                </div>
            </div>
        </div>

        <!-- Department Interface (Desktop-first design, also responsive for mobile) -->
        <div id="departmentInterface" class="hidden flex-grow desktop-layout">
            <div class="desktop-sidebar glass-card">
                <h3 class="text-xl font-bold mb-4 text-gray-800"> 转</h3>
                <input type="text" id="departmentSearch" placeholder="驻砖 /拽..." class="glass-input w-full mb-4">
                <div id="departmentOrdersList" class="space-y-3">
                    <!-- Department orders will be loaded here -->
                    <p class="text-center text-gray-500">注 转...</p>
                </div>
            </div>

            <div class="desktop-content glass-card">
                <h3 id="departmentMainTitle" class="text-xl font-bold mb-4 text-gray-800">驻专  / 驻</h3>
                <div id="departmentOrderDetails" class="hidden">
                    <div class="mb-4">
                        <span class="font-semibold">住驻专 :</span> <span id="detailOrderId"></span>
                    </div>
                    <div class="mb-4">
                        <span class="font-semibold">拽:</span> <span id="detailCustomerName"></span> (<span id="detailCustomerPhone"></span>)
                    </div>
                    <div class="mb-4">
                        <span class="font-semibold">住住:</span>
                        <select id="editOrderStatus" class="glass-select mr-2">
                            <option value="转">转</option>
                            <option value="驻">驻</option>
                            <option value=""></option>
                            <option value="专">专</option>
                            <option value="砖">砖</option>
                            <option value="注">注</option>
                        </select>
                        <button id="saveOrderStatus" class="glass-button text-sm px-4 py-2">砖专 住住</button>
                    </div>
                    <div class="mb-4">
                        <label for="editOrderETA" class="block font-semibold mb-1">爪驻 注:</label>
                        <input type="datetime-local" id="editOrderETA" class="glass-input w-full">
                        <button id="saveOrderETA" class="glass-button text-sm px-4 py-2 mt-2">砖专 爪驻</button>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">驻专 住驻拽:</h4>
                        <p id="detailDeliveryAddress"></p>
                        <p id="detailDeliveryDate"></p>
                        <p id="detailDeliveryTime"></p>
                        <p id="detailContactPerson"></p>
                        <p id="detailContactPhone"></p>
                        <p id="detailHandlingMethod"></p>
                        <p id="detailBranch"></p>
                    </div>
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">驻专:</h4>
                        <ul id="detailOrderItems" class="list-disc pr-5"></ul>
                    </div>
                    <div class="flex gap-4 mt-6">
                        <button id="printOrderButton" class="glass-button flex-1"><i class="fas fa-print ml-2"></i>驻住 </button>
                        <button id="shareDeptWhatsappButton" class="glass-button flex-1"><i class="fab fa-whatsapp ml-2"></i>砖转祝 住驻 (拽)</button>
                        <button id="shareCustomerWhatsappButton" class="glass-button flex-1"><i class="fab fa-whatsapp ml-2"></i>砖转祝 住驻 (拽)</button>
                        <button id="shareBranchWhatsappButton" class="glass-button flex-1 hidden"><i class="fab fa-whatsapp ml-2"></i>砖转祝 住驻 (住祝)</button>
                    </div>
                </div>

                <div id="departmentChatDetails" class="hidden">
                    <h4 class="font-semibold mb-2">驻转 拽:</h4>
                    <p id="detailInquiryText" class="mb-4 p-3 glass-card"></p>
                    <h4 class="font-semibold mb-2">转转 拽:</h4>
                    <textarea id="departmentResponseTextarea" class="glass-textarea w-full h-24 mb-4" placeholder="转  转 转转..."></textarea>
                    <button id="sendDepartmentResponse" class="glass-button w-full">砖 转</button>
                </div>

                <p id="departmentEmptyState" class="text-center text-gray-500 mt-10">专   驻 专砖 爪.</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation for Customer Interface -->
    <div id="bottomNav" class="bottom-nav hidden md:hidden">
        <div class="nav-item active" data-page="customerHome">
            <i class="fas fa-home"></i>
            <span>专砖</span>
        </div>
        <div class="nav-item" data-page="containerOrder">
            <i class="fas fa-dumpster"></i>
            <span></span>
        </div>
        <div class="nav-item" data-page="craneOrder">
            <i class="fas fa-truck-loading"></i>
            <span>祝</span>
        </div>
        <div class="nav-item" data-page="manualUnload">
            <i class="fas fa-hands"></i>
            <span>驻专拽 转</span>
        </div>
        <div class="nav-item" data-page="calculator">
            <i class="fas fa-calculator"></i>
            <span>砖</span>
        </div>
    </div>

    <script>
        // Configuration - REPLACE WITH YOUR APPS SCRIPT WEB APP URL
        const APPS_SCRIPT_WEB_APP_URL = https://script.google.com/macros/s/AKfycbwasF7SCeWQm73McR79htGg9PfIyjZW3mR-1AmBaXZGhLD7hDK9ELymSeR-od-kxOl1Nw/exec';
        const WA_ORDER_DEPT_PHONE = '972508860896'; // 住驻专 住驻 拽注 拽转 转

        const BRANCH_INFO = {
            '转': { name: '转', address: '转 6,  砖专', wa_phone: '972501112233' }, // 
            '专砖': { name: '专砖', address: '专砖 10,  砖专', wa_phone: '972504445566' } // 
        };

        // Global state
        let currentUserId = null;
        let currentUser = null;
        let isDepartmentUser = false; // Simple flag for department access for demo
        let allProducts = [];
        let allColors = [];
        let allInquiryTopics = [];
        let currentOrderItems = [];
        let currentFormStep = 1;;
        let allOrders = []; // Cached orders for department view
        let allInquiries = []; // Cached inquiries for department view

        // --- Utility Functions ---

        /**
         * Generic function to show a custom message box.
         * @param {string} message The message to display.
         * @returns {Promise<void>} A promise that resolves when the user closes the message box.
         */
        function showMessageBox(message) {
            return new Promise(resolve => {
                const overlay = document.getElementById('messageBoxOverlay');
                const messageBox = document.getElementById('messageBox');
                const messageBoxText = document.getElementById('messageBoxText');
                const messageBoxCloseBtn = document.getElementById('messageBoxCloseBtn');

                messageBoxText.textContent = message;
                overlay.classList.remove('hidden');
                messageBox.classList.remove('hidden');

                const closeHandler = () => {
                    overlay.classList.add('hidden');
                    messageBox.classList.add('hidden');
                    messageBoxCloseBtn.removeEventListener('click', closeHandler);
                    resolve();
                };
                messageBoxCloseBtn.addEventListener('click', closeHandler);
            });
        }

        /**
         * Simulates a fetch request to the Apps Script Web App.
         * Includes exponential backoff for retries.
         * @param {string} action The action to perform.
         * @param {Object} params Parameters for GET request.
         * @param {Object} body Data for POST request.
         * @param {number} retries Number of retries.
         * @returns {Promise<Object>} JSON response from Apps Script.
         */
        async function callAppsScript(action, params = {}, body = null, retries = 3) {
            const url = new URL(APPS_SCRIPT_WEB_APP_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }

            const options = {
                method: body ? 'POST' : 'GET',
                headers: {} // Initialize headers
            };

            if (body) {
                options.headers['Content-Type'] = 'application/json'; // Set Content-Type for JSON body
                options.body = JSON.stringify(body);
            }

            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`Attempt ${i + 1} for action '${action}'. URL: ${url.toString()}`); // Debug log
                    const response = await fetch(url.toString(), options);

                    // Check if response is OK (status 200-299)
                    if (!response.ok) {
                        const errorText = await response.text(); // Try to read response text for more details
                        console.error(`Fetch failed for action '${action}' with status ${response.status}: ${errorText}`);
                        throw new Error(`砖专转 -Apps Script  注 砖 ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    if (!result.success && result.error && result.error.includes('Sheet not found')) {
                        console.error('Apps Script Error: Sheet not found. Please verify SPREADSHEET_ID and sheet names in Code.gs.');
                        throw new Error('砖转 砖专转:   爪.   砖-SPREADSHEET_ID 砖转 转 -Code.gs .');
                    }
                    if (!result.success) {
                        throw new Error(result.error || '砖  注 砖专转');
                    }
                    return result.data || result; // Apps Script might return data or just success: true
                } catch (error) {
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000; // Exponential backoff (1s, 2s, 4s)
                        console.warn(`Retrying action '${action}' in ${delay / 1000}s due to error: ${error.message}`); // Debug log
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        console.error(`Failed to call Apps Script action '${action}' after ${retries} retries:`, error);
                        showMessageBox(`专注 砖 专 砖专转: ${error.message}. 住 砖 专 转专.`);
                        throw error;
                    }
                }
            }
        }

        /**
         * Log an action to the Apps Script backend.
         * @param {string} action
         * @param {Object} details
         */
        async function logBackendAction(action, details) {
            try {
                await callAppsScript('logAction', {}, { action, details: JSON.stringify(details), user_id: currentUserId });
            } catch (error) {
                console.error('Failed to log action to backend:', error);
            }
        }

        // --- UI Navigation ---

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const activeNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }
        }

        function showOrderFormStep(step) {
            document.querySelectorAll('.form-step').forEach(stepDiv => stepDiv.classList.add('hidden'));
            document.getElementById(`formStep${step}`).classList.remove('hidden');
            currentFormStep = step;
            updateProgressBar();
        }

        function updateProgressBar() {
            const totalSteps = 3;
            const progress = (currentFormStep / totalSteps) * 100;
            document.getElementById('orderProgressBar').style.width = `${progress}%`;
        }

        function toggleBranchSelection() {
            const handlingMethod = document.getElementById('handlingMethod').value;
            const branchSelectionDiv = document.getElementById('branchSelection');
            if (handlingMethod === '住祝 住祝') {
                branchSelectionDiv.classList.remove('hidden');
                document.getElementById('branch').setAttribute('required', 'true');
            } else {
                branchSelectionDiv.classList.add('hidden');
                document.getElementById('branch').removeAttribute('required');
            }
        }

        // --- Data Loading ---

        async function loadCustomerData() {
            try {
                // Modified to use '住驻专_'
                const customerOrders = await callAppsScript('getCustomerOrders', { customer_id: currentUser['id'] });
                renderCustomerOrders(customerOrders);

                // Modified to use 'id'
                const customerChat = await callAppsScript('getCustomerChat', { customer_id: currentUser['id'] });
                renderCustomerChat(customerChat);
            } catch (error) {
                console.error('Failed to load customer data:', error);
                showMessageBox('砖 注转 转 拽.');
            }
        }

        async function loadDepartmentData() {
            try {
                allOrders = await callAppsScript('getOrders');
                allInquiries = await callAppsScript('getChatInquiries');
                renderDepartmentOrdersAndInquiries();
            } catch (error) {
                console.error('Failed to load department data:', error);
                showMessageBox('砖 注转 转 拽.');
            }
        }

        // --- Rendering Functions ---

        function renderCustomerOrders(orders) {
            const list = document.getElementById('customerOrdersList');
            list.innerHTML = ''; // Clear previous orders

            if (orders && orders.length > 0) {
                orders.sort((a, b) => new Date(b['created_at']) - new Date(a['created_at'])); // Sort by creation date
                orders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'glass-card p-4 rounded-lg shadow-sm';
                    orderDiv.innerHTML = `
                        <p class="font-semibold text-gray-800"> #${order['id']}</p>
                        <p class="text-sm text-gray-600">住 驻注: ${order['order_type']}</p>
                        <p class="text-sm text-gray-600">住住: <span class="font-medium text-blue-600">${order['status']}</span></p>
                        ${order['eta'] ? `<p class="text-sm text-gray-600">爪驻 注: ${new Date(order['eta']).toLocaleString('he-IL')}</p>` : ''}
                        <p class="text-xs text-gray-500 mt-2">爪专 : ${new Date(order['created_at']).toLocaleString('he-IL')}</p>
                    `;
                    list.appendChild(orderDiv);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500"> 转 拽转.</p>';
            }
        }

        function renderCustomerChat(inquiries) {
            const list = document.getElementById('customerChatList');
            list.innerHTML = ''; // Clear previous inquiries

            if (inquiries && inquiries.length > 0) {
                inquiries.sort((a, b) => new Date(b['timestamp']) - new Date(a['timestamp'])); // Sort by timestamp
                inquiries.forEach(inquiry => {
                    const inquiryDiv = document.createElement('div');
                    inquiryDiv.className = 'glass-card p-4 rounded-lg shadow-sm';
                    inquiryDiv.innerHTML = `
                        <p class="font-semibold text-gray-800">驻 #${inquiry['id']}</p>
                        <p class="text-sm text-gray-600">砖: ${inquiry['customer_text']}</p>
                        ${inquiry['department_response'] ? `<p class="text-sm text-gray-600">转砖: <span class="font-medium text-green-600">${inquiry['department_response']}</span></p>` : '<p class="text-sm text-gray-600">转砖: <span class="font-medium text-yellow-600">转 转砖</span></p>'}
                        <p class="text-xs text-gray-500 mt-2">砖专 : ${new Date(inquiry['timestamp']).toLocaleString('he-IL')}</p>
                        ${inquiry['order_link'] ? `<p class="text-xs text-gray-500">拽砖专 : ${inquiry['order_link']}</p>` : ''}
                    `;
                    list.appendChild(inquiryDiv);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500"> 驻转 拽转.</p>';
            }
        }


        function renderDepartmentOrdersAndInquiries(filterText = '') {
            const list = document.getElementById('departmentOrdersList');
            list.innerHTML = '';

            const combinedItems = [
                ...allOrders.map(order => ({ type: 'order', ...order })),
                ...allInquiries.map(inquiry => ({ type: 'inquiry', ...inquiry }))
            ];

            combinedItems.sort((a, b) => {
                const dateA = new Date(a.type === 'order' ? a['created_at'] : a['timestamp']);
                const dateB = new Date(b.type === 'order' ? b['created_at'] : b['timestamp']);
                return dateB - dateA;
            });

            const filteredItems = filterText ? combinedItems.filter(item => {
                const textToSearch = item.type === 'order' ?
                    `${item['id']} ${item['customer_name']} ${item['customer_phone']} ${item['order_type']} ${item['status']}` :
                    `${item['id']} ${item['customer_id']} ${item['customer_text']} ${item['status']}`;
                return textToSearch.toLowerCase().includes(filterText.toLowerCase());
            }) : combinedItems;


            if (filteredItems.length > 0) {
                filteredItems.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'glass-card p-3 rounded-lg shadow-sm cursor-pointer hover:bg-white/30 transition';
                    itemDiv.dataset.id = item.type === 'order' ? item['id'] : item['id'];
                    itemDiv.dataset.type = item.type;
                    itemDiv.addEventListener('click', () => showDepartmentDetails(item));

                    if (item.type === 'order') {
                        itemDiv.innerHTML = `
                            <p class="font-semibold text-gray-800"> #${item['id']}</p>
                            <p class="text-sm text-gray-600">${item['customer_name']} - ${item['order_type']}</p>
                            <p class="text-sm text-gray-600">住住: <span class="font-medium text-blue-600">${item['status']}</span></p>
                        `;
                    } else { // Inquiry
                        itemDiv.innerHTML = `
                            <p class="font-semibold text-gray-800">驻 #${item['id']}</p>
                            <p class="text-sm text-gray-600">${item['customer_id']} - ${item['customer_text'].substring(0, 30)}...</p>
                            <p class="text-sm text-gray-600">住住: <span class="font-medium ${item['status'] === '注' ? 'text-green-600' : 'text-yellow-600'}">${item['status']}</span></p>
                        `;
                    }
                    list.appendChild(itemDiv);
                });
            } else {
                list.innerHTML = '<p class="text-center text-gray-500"> 驻专 爪.</p>';
            }
        }

        function showDepartmentDetails(item) {
            document.getElementById('departmentOrderDetails').classList.add('hidden');
            document.getElementById('departmentChatDetails').classList.add('hidden');
            document.getElementById('departmentEmptyState').classList.add('hidden');
            document.getElementById('departmentMainTitle').textContent = ''; // Clear title

            if (item.type === 'order') {
                document.getElementById('departmentOrderDetails').classList.remove('hidden');
                document.getElementById('departmentMainTitle').textContent = `驻专  #${item['id']}`;

                document.getElementById('detailOrderId').textContent = item['id'];
                document.getElementById('detailCustomerName').textContent = item['customer_name'];
                document.getElementById('detailCustomerPhone').textContent = item['customer_phone'];
                document.getElementById('editOrderStatus').value = item['status'];
                document.getElementById('editOrderETA').value = item['eta'] ? new Date(item['eta']).toISOString().slice(0, 16) : '';

                document.getElementById('detailDeliveryAddress').textContent = `转转: ${item['delivery_address']}`;
                document.getElementById('detailDeliveryDate').textContent = `转专: ${item['delivery_date']}`;
                document.getElementById('detailDeliveryTime').textContent = `砖注转: ${item['delivery_time']}`;
                document.getElementById('detailContactPerson').textContent = `砖 拽砖专: ${item['contact_person']}`;
                document.getElementById('detailContactPhone').textContent = `驻 砖 拽砖专: ${item['contact_phone']}`;
                document.getElementById('detailHandlingMethod').textContent = `专 驻: ${item['handling_method']}`;
                document.getElementById('detailBranch').textContent = `住祝: ${item['branch']}`;

                const itemsList = document.getElementById('detailOrderItems');
                itemsList.innerHTML = '';
                try {
                    const orderItems = JSON.parse(item['items']);
                    orderItems.forEach(i => {
                        const product = allProducts.find(p => p['sku'] === i.sku);
                        const productName = product ? product['name'] : `${i.name} `;
                        const itemColor = i.color ? ` (${i.color})` : '';
                        const li = document.createElement('li');
                        li.innerHTML = `${productName}${itemColor}, 转: ${i.qty} ${i.unit || ''}`;
                        itemsList.appendChild(li);
                    });
                } catch (e) {
                    itemsList.innerHTML = `<li>砖 注转 驻专.</li>`;
                }

                // Update WhatsApp buttons based on order type and target
                const shareBranchWaButton = document.getElementById('shareBranchWhatsappButton');
                if (item['branch'] && BRANCH_INFO[item['branch']]) {
                    shareBranchWaButton.classList.remove('hidden');
                } else {
                    shareBranchWaButton.classList.add('hidden');
                }

            } else { // Inquiry
                document.getElementById('departmentChatDetails').classList.remove('hidden');
                document.getElementById('departmentMainTitle').textContent = `驻专 驻 #${item['id']}`;

                document.getElementById('detailInquiryText').textContent = item['customer_text'];
                document.getElementById('departmentResponseTextarea').value = item['department_response'] || '';
                document.getElementById('sendDepartmentResponse').dataset.inquiryId = item['id'];
            }
        }


        function updateOrderSummary() {
            const summaryDiv = document.getElementById('orderSummary');
            const orderType = document.getElementById('orderType').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            const deliveryTime = document.getElementById('deliveryTime').value;
            const contactPerson = document.getElementById('contactPerson').value;
            const contactPhone = document.getElementById('contactPhone').value;
            const handlingMethod = document.getElementById('handlingMethod').value;
            const branch = document.getElementById('branch').value;

            let itemsSummary = currentOrderItems.map(item => {
                const product = allProducts.find(p => p['sku'] === item.sku);
                const productName = product ? product['name'] : `${item.name}  (爪专  )`;
                const itemColor = item.color ? ` (${item.color})` : '';
                return `<li>${productName}${itemColor}, 转: ${item.qty} ${item.unit || ''}</li>`;
            }).join('');

            summaryDiv.innerHTML = `
                <p><strong>住 驻注:</strong> ${orderType}</p>
                <p><strong>转转 住驻拽:</strong> ${deliveryAddress}</p>
                <p><strong>转专 住驻拽:</strong> ${deliveryDate}</p>
                <p><strong>砖注转 住驻拽:</strong> ${deliveryTime}</p>
                <p><strong>砖 拽砖专:</strong> ${contactPerson} (驻: ${contactPhone})</p>
                <p><strong>专 驻:</strong> ${handlingMethod}</p>
                ${handlingMethod === '住祝 住祝' && branch ? `<p><strong>住祝 驻:</strong> ${BRANCH_INFO[branch]?.name || branch}</p>` : ''}
                <p><strong>驻专:</strong></p>
                <ul class="list-disc pr-5">${itemsSummary || ' 驻专'}</ul>
            `;
        }


        // --- Auth & Initial Load ---

        async function handleLogin() {
            const phone = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const loginError = document.getElementById('loginError');

            if (!phone || !password) {
                loginError.textContent = '  驻 住住.';
                loginError.classList.remove('hidden');
                return;
            }

            try {
                const response = await callAppsScript('login', {}, { phone, password });
                if (response.success) {
                    currentUser = response.customer;
                    currentUserId = currentUser['id']; // Changed to 'id'
                    isDepartmentUser = (currentUser['status'] === '拽'); // Changed to 'status'

                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('appContent').classList.remove('hidden');
                    document.getElementById('customerGreeting').textContent = `砖, ${currentUser['name']}!`; // Changed to 'name'

                    // Show appropriate interface
                    if (isDepartmentUser) {
                        document.getElementById('customerInterface').classList.add('hidden');
                        document.getElementById('bottomNav').classList.add('hidden');
                        document.getElementById('departmentInterface').classList.remove('hidden');
                        loadDepartmentData();
                    } else {
                        document.getElementById('customerInterface').classList.remove('hidden');
                        document.getElementById('bottomNav').classList.remove('hidden');
                        document.getElementById('departmentInterface').classList.add('hidden');
                        loadCustomerData();
                        showPage('customerHome'); // Default to home page for customer
                    }

                    logBackendAction('Login Success', { customer_id: currentUserId, phone: phone });
                    // Store user info in localStorage for offline (simple demo, ideally use tokens)
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.setItem('currentUserId', currentUserId);

                } else {
                    loginError.textContent = '砖 砖转砖  住住 砖.';
                    loginError.classList.remove('hidden');
                    logBackendAction('Login Failed', { phone: phone, error: response.error });
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.textContent = '砖 转专转. 住 砖 专 转专.';
                loginError.classList.remove('hidden');
                logBackendAction('Login Error', { phone: phone, error: error.message });
            }
        }

        async function loadInitialData() {
            try {
                allProducts = await callAppsScript('getProducts');
                allColors = await callAppsScript('getColorPalette');
                allInquiryTopics = await callAppsScript('getInquiryTopics');

                // Populate inquiry topics dropdown (if needed) - not directly in current form, but good for future
                // const orderTypeSelect = document.getElementById('orderType');
                // allInquiryTopics.forEach(topic => {
                //     const option = document.createElement('option');
                //     option.value = topic['砖_驻'];
                //     option.textContent = topic['砖_驻'];
                //     orderTypeSelect.appendChild(option);
                // });

            } catch (error) {
                console.error('Failed to load initial data:', error);
                showMessageBox('砖 注转 转 砖.  专注 转 注.');
            }
        }

        async function checkLocalStorageAndLogin() {
            const storedUser = localStorage.getItem('currentUser');
            const storedUserId = localStorage.getItem('currentUserId');
            if (storedUser && storedUserId) {
                currentUser = JSON.parse(storedUser);
                currentUserId = storedUserId;
                isDepartmentUser = (currentUser['status'] === '拽'); // Changed to 'status'

                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                document.getElementById('customerGreeting').textContent = `砖, ${currentUser['name']}!`; // Changed to 'name'

                if (isDepartmentUser) {
                    document.getElementById('customerInterface').classList.add('hidden');
                    document.getElementById('bottomNav').classList.add('hidden');
                    document.getElementById('departmentInterface').classList.remove('hidden');
                    loadDepartmentData();
                } else {
                    document.getElementById('customerInterface').classList.remove('hidden');
                    document.getElementById('bottomNav').classList.remove('hidden');
                    document.getElementById('departmentInterface').classList.add('hidden');
                    loadCustomerData();
                    showPage('customerHome');
                }
            } else {
                document.getElementById('loginPage').classList.remove('hidden');
                document.getElementById('appContent').classList.add('hidden');
            }
        }


        // --- Order Form Logic ---

        function createItemRow(item = { name: '', sku: '', qty: 1, unit: '', color: '' }) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex flex-col md:flex-row gap-2 glass-card p-3 rounded-md relative';
            itemDiv.innerHTML = `
                <input type="text" placeholder="砖 爪专" class="glass-input flex-1 product-name" value="${item.name}" required list="productSuggestions">
                <datalist id="productSuggestions"></datalist>
                <input type="number" placeholder="转" class="glass-input w-20" value="${item.qty}" min="1" required>
                <input type="text" placeholder="" class="glass-input w-20" value="${item.unit}">
                <input type="text" placeholder=" (拽/砖)" class="glass-input flex-1 color-input" value="${item.color}" list="colorSuggestions">
                <datalist id="colorSuggestions"></datalist>
                <button type="button" class="remove-item-button absolute top-2 left-2 text-red-500 hover:text-red-700">
                    <i class="fas fa-times-circle"></i>
                </button>
            `;

            // Setup autocomplete for product names
            const productNameInput = itemDiv.querySelector('.product-name');
            const productDatalist = itemDiv.querySelector('#productSuggestions');
            productNameInput.addEventListener('input', () => {
                const query = productNameInput.value;
                productDatalist.innerHTML = '';
                if (query.length > 1) {
                    const filteredProducts = allProducts.filter(p => p['name'].toLowerCase().includes(query.toLowerCase()));
                    filteredProducts.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product['name'];
                        productDatalist.appendChild(option);
                    });
                }
            });
            productNameInput.addEventListener('change', () => {
                const selectedProduct = allProducts.find(p => p['name'] === productNameInput.value);
                if (selectedProduct) {
                    itemDiv.querySelector('input[placeholder=""]').value = selectedProduct['unit'];
                    // Store SKU temporarily or find a way to map it
                }
            });


            // Setup autocomplete for color names
            const colorInput = itemDiv.querySelector('.color-input');
            const colorDatalist = itemDiv.querySelector('#colorSuggestions');
            colorInput.addEventListener('input', () => {
                const query = colorInput.value;
                colorDatalist.innerHTML = '';
                if (query.length > 1) {
                    const filteredColors = allColors.filter(c =>
                        c['color_name'].toLowerCase().includes(query.toLowerCase()) ||
                        c['color_code'].toLowerCase().includes(query.toLowerCase())
                    );
                    filteredColors.forEach(color => {
                        const option = document.createElement('option');
                        option.value = `${color['color_code']} ${color['color_name']} (${color['brand']})`;
                        colorDatalist.appendChild(option);
                    });
                }
            });


            itemDiv.querySelector('.remove-item-button').addEventListener('click', () => {
                itemDiv.remove();
                currentOrderItems = currentOrderItems.filter(i => i !== item); // Remove from array
            });

            return itemDiv;
        }

        function collectOrderItems() {
            const itemsContainer = document.getElementById('orderItemsContainer');
            const items = [];
            itemsContainer.querySelectorAll('.flex.flex-col.md\\:flex-row.gap-2').forEach(itemDiv => {
                const productName = itemDiv.querySelector('input[placeholder="砖 爪专"]').value;
                const qty = itemDiv.querySelector('input[type="number"]').value;
                const unit = itemDiv.querySelector('input[placeholder=""]').value;
                const color = itemDiv.querySelector('input[placeholder=" (拽/砖)"]').value;

                // Attempt to find SKU based on product name
                const product = allProducts.find(p => p['name'] === productName);
                const sku = product ? product['sku'] : `CUSTOM_${productName.replace(/\s/g, '_')}`; // Fallback SKU

                if (productName && qty) {
                    items.push({ name: productName, sku, qty: parseInt(qty), unit, color });
                }
            });
            return items;
        }

        async function submitOrder(event) {
            event.preventDefault();

            currentOrderItems = collectOrderItems(); // Ensure items are updated before submission

            if (currentOrderItems.length === 0 && document.getElementById('orderType').value !== '砖 注 注 住驻拽') {
                showMessageBox(' 住祝 驻转 驻专  ,  专 住 驻注 "砖 注 注 住驻拽".');
                return;
            }

            const orderData = {
                customer_id: currentUser['id'],
                customer_name: currentUser['name'],
                customer_phone: currentUser['phone'],
                order_type: document.getElementById('orderType').value,
                delivery_address: document.getElementById('deliveryAddress').value,
                delivery_date: document.getElementById('deliveryDate').value,
                delivery_time: document.getElementById('deliveryTime').value,
                contact_person: document.getElementById('contactPerson').value,
                contact_phone: document.getElementById('contactPhone').value,
                handling_method: document.getElementById('handlingMethod').value,
                branch: document.getElementById('branch').value,
                items: currentOrderItems
            };

            try {
                const response = await callAppsScript('createOrder', {}, orderData);
                if (response.success) {
                    const newOrder = response.order;
                    // Generate WhatsApp URL and redirect
                    const waResponse = await callAppsScript('getWhatsAppUrl', { order_id: newOrder['id'], target: 'department' });
                    window.open(waResponse.url, '_blank');

                    await showMessageBox(` #${newOrder['id']} 砖 爪 住驻 砖 拽转 转!`);

                    // Reset form and return to home
                    document.getElementById('orderForm').reset();
                    document.getElementById('orderItemsContainer').innerHTML = '';
                    currentOrderItems = [];
                    showOrderFormStep(1);
                    showPage('customerHome');
                    loadCustomerData(); // Refresh customer orders
                    logBackendAction('Order Created', { order_id: newOrder['id'], customer_id: currentUserId });
                }
            } catch (error) {
                console.error('Order submission error:', error);
                showMessageBox('砖 砖转 .');
            }
        }


        // --- Department Functions ---

        async function saveDepartmentOrderStatus() {
            const orderId = document.getElementById('detailOrderId').textContent;
            const newStatus = document.getElementById('editOrderStatus').value;
            try {
                const updatedOrder = await callAppsScript('updateOrder', {}, {
                    order_id: orderId,
                    updated_data: { 'status': newStatus },
                    updated_by: currentUserId
                });
                if (updatedOrder.success) {
                    await showMessageBox(`住住  #${orderId} 注 : ${newStatus}.`);
                    await loadDepartmentData(); // Refresh list
                    logBackendAction('Order Status Updated', { order_id: orderId, new_status: newStatus, updated_by: currentUserId });
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showMessageBox('砖 注 住住 .');
            }
        }

        async function saveDepartmentOrderETA() {
            const orderId = document.getElementById('detailOrderId').textContent;
            const newETA = document.getElementById('editOrderETA').value;
            try {
                const updatedOrder = await callAppsScript('updateOrder', {}, {
                    order_id: orderId,
                    updated_data: { 'eta': newETA },
                    updated_by: currentUserId
                });
                if (updatedOrder.success) {
                    await showMessageBox(`爪驻 注  #${orderId} 注 : ${newETA}.`);
                    await loadDepartmentData(); // Refresh list
                    logBackendAction('Order ETA Updated', { order_id: orderId, new_eta: newETA, updated_by: currentUserId });
                }
            } catch (error) {
                console.error('Error updating order ETA:', error);
                showMessageBox('砖 注 爪驻 注.');
            }
        }

        async function sendDepartmentResponse() {
            const inquiryId = document.getElementById('sendDepartmentResponse').dataset.inquiryId;
            const responseText = document.getElementById('departmentResponseTextarea').value.trim();

            if (!responseText) {
                showMessageBox(' 转 转 驻 砖.');
                return;
            }

            try {
                const updatedInquiry = await callAppsScript('updateChatInquiry', {}, {
                    inquiry_id: inquiryId,
                    department_response: responseText,
                    updated_by: currentUserId
                });
                if (updatedInquiry.success) {
                    await showMessageBox(`转转 驻 #${inquiryId} 砖 爪.`);
                    await loadDepartmentData(); // Refresh list
                    logBackendAction('Chat Inquiry Response', { inquiry_id: inquiryId, response: responseText, updated_by: currentUserId });
                }
            } catch (error) {
                console.error('Error sending department response:', error);
                showMessageBox('砖 砖转 转.');
            }
        }

        async function generatePrintableView(orderId) {
            const order = allOrders.find(o => o['id'] === orderId);
            if (!order) {
                showMessageBox('  爪 驻住.');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="he" dir="rtl">
                <head>
                    <title>驻住转  #${orderId}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20mm; color: #333; }
                        h1 { text-align: center; margin-bottom: 20px; color: #007bff; }
                        .section { margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
                        .section:last-child { border-bottom: none; }
                        p { margin: 5px 0; line-height: 1.4; }
                        ul { list-style: disc; padding-right: 20px; margin-top: 5px; }
                        li { margin-bottom: 3px; }
                        .header-info { text-align: center; margin-bottom: 30px; }
                        .header-info img { max-width: 150px; margin-bottom: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header-info">
                        <img src="https://placehold.co/150x50/A0C4FF/0A2342?text=+住" alt=" . 住">
                        <h1> 住祝: ${order['branch'] || ''}</h1>
                        <p>住驻专 : <strong>${order['id']}</strong></p>
                        <p>转专 : ${new Date(order['created_at']).toLocaleDateString('he-IL')}</p>
                    </div>

                    <div class="section">
                        <h2>驻专 拽</h2>
                        <p><strong>砖 拽:</strong> ${order['customer_name']}</p>
                        <p><strong>驻 拽:</strong> ${order['customer_phone']}</p>
                    </div>

                    <div class="section">
                        <h2>驻专 住驻拽</h2>
                        <p><strong>住 驻注:</strong> ${order['order_type']}</p>
                        <p><strong>转转 住驻拽:</strong> ${order['delivery_address']}</p>
                        <p><strong>转专 住驻拽 拽砖:</strong> ${order['delivery_date']}</p>
                        <p><strong>砖注转 住驻拽 拽砖转:</strong> ${order['delivery_time']}</p>
                        <p><strong>砖 拽砖专 转专:</strong> ${order['contact_person']}</p>
                        <p><strong>驻 砖 拽砖专:</strong> ${order['contact_phone']}</p>
                        <p><strong>专 驻:</strong> ${order['handling_method']}</p>
                        <p><strong>住祝 驻:</strong> ${order['branch']}</p>
                        <p><strong>住住 :</strong> ${order['status']}</p>
                        ${order['eta'] ? `<p><strong>爪驻 注:</strong> ${new Date(order['eta']).toLocaleString('he-IL')}</p>` : ''}
                    </div>

                    <div class="section">
                        <h2>驻专</h2>
                        <ul>
                            ${(() => {
                                try {
                                    return JSON.parse(order['items']).map(item => {
                                        const product = allProducts.find(p => p['sku'] === item.sku);
                                        const productName = product ? product['name'] : `${item.name}  ( )`;
                                        const itemColor = item.color ? ` (${item.color})` : '';
                                        return `<li>${productName}${itemColor}, 转: ${item.qty} ${item.unit || ''}</li>`;
                                    }).join('');
                                } catch (e) {
                                    return '<li>砖 注转 驻专.</li>';
                                }
                            })()}
                        </ul>
                    </div>

                    <div class="section" style="text-align: center; margin-top: 30px;">
                        <p>--- 转 注 转 ---</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();

            // Mark as printed
            try {
                await callAppsScript('updateOrder', {}, {
                    order_id: orderId,
                    updated_data: { 'printed': '' },
                    updated_by: currentUserId
                });
                await loadDepartmentData(); // Refresh list
                logBackendAction('Order Printed', { order_id: orderId, updated_by: currentUserId });
            } catch (error) {
                console.error('Error marking order as printed:', error);
            }
        }


        // --- Calculator Logic ---

        function calculateDrywall() {
            const length = parseFloat(document.getElementById('drywallLength').value);
            const width = parseFloat(document.getElementById('drywallWidth').value);
            const resultElement = document.getElementById('drywallResult');
            if (!isNaN(length) && !isNaN(width)) {
                resultElement.textContent = (length * width).toFixed(2);
            } else {
                resultElement.textContent = '0';
            }
        }

        function calculateAdhesive() {
            const area = parseFloat(document.getElementById('adhesiveArea').value);
            const coverage = parseFloat(document.getElementById('adhesiveCoverage').value);
            const resultElement = document.getElementById('adhesiveResult');
            if (!isNaN(area) && !isNaN(coverage) && coverage > 0) {
                resultElement.textContent = Math.ceil(area / coverage);
            } else {
                resultElement.textContent = '0';
            }
        }

        function calculateGravel() {
            const length = parseFloat(document.getElementById('gravelLength').value);
            const width = parseFloat(document.getElementById('gravelWidth').value);
            const height = parseFloat(document.getElementById('gravelHeight').value);
            const volumeResult = document.getElementById('gravelVolumeResult');
            const bagsResult = document.getElementById('gravelBagsResult');

            if (!isNaN(length) && !isNaN(width) && !isNaN(height)) {
                const volume = length * width * height;
                volumeResult.textContent = volume.toFixed(2);
                bagsResult.textContent = Math.ceil(volume / 0.5); // Half a cube per bag
            } else {
                volumeResult.textContent = '0';
                bagsResult.textContent = '0';
            }
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', async () => {
            await loadInitialData();
            await checkLocalStorageAndLogin();

            // Login Page
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Customer Interface Navigation
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const page = item.dataset.page;
                    if (page === 'calculator') {
                        document.getElementById('calculatorPopup').classList.remove('hidden');
                        document.getElementById('messageBoxOverlay').classList.remove('hidden'); // Use overlay for calculator
                    } else {
                        showPage(page);
                    }
                });
            });

            document.getElementById('newOrderButton').addEventListener('click', () => {
                showPage('newOrderFormPage');
                showOrderFormStep(1); // Start new order form at step 1
            });

            // Order Form Navigation
            document.getElementById('nextStep1').addEventListener('click', () => showOrderFormStep(2));
            document.getElementById('prevStep2').addEventListener('click', () => showOrderFormStep(1));
            document.getElementById('nextStep2').addEventListener('click', () => {
                // Validate step 2 inputs before proceeding
                const form = document.getElementById('orderForm');
                const inputs = formStep2.querySelectorAll('input[required], select[required]');
                let allValid = true;
                inputs.forEach(input => {
                    if (!input.value) {
                        input.reportValidity(); // Show browser validation message
                        allValid = false;
                    }
                });
                if (allValid) {
                    currentOrderItems = collectOrderItems(); // Collect items for summary
                    updateOrderSummary();
                    showOrderFormStep(3);
                } else {
                    showMessageBox('  转  砖转 住 .');
                }
            });
            document.getElementById('prevStep3').addEventListener('click', () => showOrderFormStep(2));
            document.getElementById('orderForm').addEventListener('submit', submitOrder);

            // Add Item button
            document.getElementById('addItemButton').addEventListener('click', () => {
                const newItem = { name: '', sku: '', qty: 1, unit: '', color: '' };
                currentOrderItems.push(newItem);
                document.getElementById('orderItemsContainer').appendChild(createItemRow(newItem));
            });
            // Add initial item row
            document.getElementById('orderItemsContainer').appendChild(createItemRow());


            // Offline support (simple form data storage)
            document.getElementById('orderForm').addEventListener('input', () => {
                localStorage.setItem('offlineOrderForm', JSON.stringify({
                    orderType: document.getElementById('orderType').value,
                    deliveryAddress: document.getElementById('deliveryAddress').value,
                    deliveryDate: document.getElementById('deliveryDate').value,
                    deliveryTime: document.getElementById('deliveryTime').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    handlingMethod: document.getElementById('handlingMethod').value,
                    branch: document.getElementById('branch').value,
                    items: collectOrderItems()
                }));
            });

            // Load offline data if available
            const savedFormData = localStorage.getItem('offlineOrderForm');
            if (savedFormData) {
                const data = JSON.parse(savedFormData);
                document.getElementById('orderType').value = data.orderType || '';
                document.getElementById('deliveryAddress').value = data.deliveryAddress || '';
                document.getElementById('deliveryDate').value = data.deliveryDate || '';
                document.getElementById('deliveryTime').value = data.deliveryTime || '';
                document.getElementById('contactPerson').value = data.contactPerson || '';
                document.getElementById('contactPhone').value = data.contactPhone || '';
                document.getElementById('handlingMethod').value = data.handlingMethod || '';
                document.getElementById('branch').value = data.branch || '';

                if (data.items && data.items.length > 0) {
                    document.getElementById('orderItemsContainer').innerHTML = ''; // Clear default
                    data.items.forEach(item => {
                        document.getElementById('orderItemsContainer').appendChild(createItemRow(item));
                    });
                    currentOrderItems = data.items;
                }
                showMessageBox('驻住  拽 砖专 (砖专 爪  拽).');
            }


            // Toggle branch selection based on handling method
            document.getElementById('handlingMethod').addEventListener('change', toggleBranchSelection);
            toggleBranchSelection(); // Call on load

            // Calculator
            document.getElementById('calcType').addEventListener('change', (e) => {
                document.querySelectorAll('.calc-section').forEach(sec => sec.classList.add('hidden'));
                document.getElementById(`${e.target.value}Calc`).classList.remove('hidden');
            });
            document.getElementById('drywallLength').addEventListener('input', calculateDrywall);
            document.getElementById('drywallWidth').addEventListener('input', calculateDrywall);
            document.getElementById('adhesiveArea').addEventListener('input', calculateAdhesive);
            document.getElementById('adhesiveCoverage').addEventListener('input', calculateAdhesive);
            document.getElementById('gravelLength').addEventListener('input', calculateGravel);
            document.getElementById('gravelWidth').addEventListener('input', calculateGravel);
            document.getElementById('gravelHeight').addEventListener('input', calculateGravel);
            document.getElementById('closeCalculator').addEventListener('click', () => {
                document.getElementById('calculatorPopup').classList.add('hidden');
                document.getElementById('messageBoxOverlay').classList.add('hidden');
            });

            // Department Interface
            document.getElementById('departmentSearch').addEventListener('input', (e) => {
                renderDepartmentOrdersAndInquiries(e.target.value);
            });
            document.getElementById('saveOrderStatus').addEventListener('click', saveDepartmentOrderStatus);
            document.getElementById('saveOrderETA').addEventListener('click', saveDepartmentOrderETA);
            document.getElementById('sendDepartmentResponse').addEventListener('click', sendDepartmentResponse);
            document.getElementById('printOrderButton').addEventListener('click', () => {
                const orderId = document.getElementById('detailOrderId').textContent;
                generatePrintableView(orderId);
            });
            document.getElementById('shareDeptWhatsappButton').addEventListener('click', async () => {
                const orderId = document.getElementById('detailOrderId').textContent;
                try {
                    const waResponse = await callAppsScript('getWhatsAppUrl', { order_id: orderId, target: 'department' });
                    window.open(waResponse.url, '_blank');
                    await showMessageBox('注转 住驻 拽 砖.');
                    logBackendAction('WhatsApp Shared (Dept)', { order_id: orderId, updated_by: currentUserId });
                } catch (error) {
                    console.error('Error sharing to department WhatsApp:', error);
                    showMessageBox('砖 砖转 注转 住驻 拽.');
                }
            });
            document.getElementById('shareCustomerWhatsappButton').addEventListener('click', async () => {
                const orderId = document.getElementById('detailOrderId').textContent;
                try {
                    const waResponse = await callAppsScript('getWhatsAppUrl', { order_id: orderId, target: 'customer' });
                    window.open(waResponse.url, '_blank');
                    await showMessageBox('注转 住驻 拽 砖.');
                    logBackendAction('WhatsApp Shared (Customer)', { order_id: orderId, updated_by: currentUserId });
                } catch (error) {
                    console.error('Error sharing to customer WhatsApp:', error);
                    showMessageBox('砖 砖转 注转 住驻 拽.');
                }
            });
            document.getElementById('shareBranchWhatsappButton').addEventListener('click', async () => {
                const orderId = document.getElementById('detailOrderId').textContent;
                try {
                    const waResponse = await callAppsScript('getWhatsAppUrl', { order_id: orderId, target: 'branch' });
                    window.open(waResponse.url, '_blank');
                    await showMessageBox('注转 住驻 住祝 砖.');
                    logBackendAction('WhatsApp Shared (Branch)', { order_id: orderId, updated_by: currentUserId });
                } catch (error) {
                    console.error('Error sharing to branch WhatsApp:', error);
                    showMessageBox('砖 砖转 注转 住驻 住祝.');
                }
            });


            // Auto-refresh for department interface (every 30 seconds)
            setInterval(() => {
                if (isDepartmentUser && !document.getElementById('departmentInterface').classList.contains('hidden')) {
                    loadDepartmentData();
                    console.log('Department data refreshed automatically.');
                }
            }, 30000); // Refresh every 30 seconds


            // Initial load of first item row
            document.getElementById('orderItemsContainer').appendChild(createItemRow());
        });
    </script>
</body>
</html>
