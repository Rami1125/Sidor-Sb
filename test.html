<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>ניהול נתונים מגיליונות</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .tab { cursor: pointer; padding: 8px 16px; }
    .tab.active { background-color: #2563eb; color: white; border-radius: 8px; }
    td[contenteditable="true"] { background: #fef9c3; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <h1 class="text-2xl font-bold mb-4">📊 מערכת ניהול נתונים מגוגל שיטס</h1>

  <!-- Tabs -->
  <div id="tabs" class="flex space-x-2 mb-4"></div>

  <!-- Table container -->
  <div id="table-container" class="bg-white rounded-2xl shadow p-4 overflow-x-auto"></div>

  <!-- Message -->
  <div id="message" class="fixed bottom-4 right-4 p-3 rounded-2xl shadow hidden"></div>

  <script>
    const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxXJEFzczFErF6s6wAHFDYkMHseuYfDQc6z_4fYbD7iqpRI3q9XoOSQRTIeMI213QLaOw/exec";

    // Tabs definition (must match sheet names!)
    const SHEETS = [
      "לקוחות", "הזמנות", "מוצרים", "מניפת_צבעים", "צ_אט_פניות", "נושאי_פנייה", "Logs"
    ];

    let currentSheet = null;
    let currentData = [];

    // Build tabs
    const tabsEl = document.getElementById("tabs");
    SHEETS.forEach(sheet => {
      const btn = document.createElement("div");
      btn.innerText = sheet;
      btn.className = "tab bg-gray-200";
      btn.onclick = () => loadSheet(sheet, btn);
      tabsEl.appendChild(btn);
    });

    async function callAppsScript(action, params = {}) {
      try {
        const url = new URL(APPS_SCRIPT_WEB_APP_URL);
        url.searchParams.set("action", action);
        Object.entries(params).forEach(([k,v]) => url.searchParams.set(k,v));
        const res = await fetch(url);
        return await res.json();
      } catch (e) {
        showMessage("❌ Error: " + e.message, true);
        throw e;
      }
    }

    async function loadSheet(sheetName, btn) {
      // activate tab
      [...tabsEl.children].forEach(c => c.classList.remove("active"));
      btn.classList.add("active");

      currentSheet = sheetName;
      showMessage("🔄 Loading " + sheetName + "...");

      const data = await callAppsScript("getSheetData", { sheetName });
      if (!data.success) {
        showMessage("❌ Failed to load " + sheetName, true);
        return;
      }

      currentData = data.rows;
      renderTable(currentData);
      showMessage("✅ Loaded " + sheetName);
    }

    function renderTable(rows) {
      const container = document.getElementById("table-container");
      if (!rows || rows.length === 0) {
        container.innerHTML = "<p>No data.</p>";
        return;
      }

      const headers = Object.keys(rows[0]);
      let html = `<table class="min-w-full border text-sm"><thead><tr>`;
      headers.forEach(h => {
        html += `<th class="border px-2 py-1 bg-gray-100">${h}</th>`;
      });
      html += `<th class="border px-2 py-1 bg-gray-100">Actions</th>`;
      html += `</tr></thead><tbody>`;

      rows.forEach((row, i) => {
        html += `<tr>`;
        headers.forEach(h => {
          html += `<td contenteditable="true" data-row="${i}" data-key="${h}" class="border px-2 py-1">${row[h] || ""}</td>`;
        });
        html += `<td class="border px-2 py-1">
                   <button onclick="saveRow(${i})" class="bg-blue-500 text-white px-2 py-1 rounded">💾 Save</button>
                 </td>`;
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;
    }

    async function saveRow(index) {
      const row = { ...currentData[index] };
      // collect edited cells
      document.querySelectorAll(`[data-row="${index}"]`).forEach(td => {
        row[td.dataset.key] = td.innerText.trim();
      });

      // use "id" or "sku" or fallback first header
      const pk = row.id || row.sku || row[Object.keys(row)[0]];
      showMessage("🔄 Saving...");

      const res = await callAppsScript("updateRowInSheet", {
        sheetName: currentSheet,
        primaryKeyHeader: row.id ? "id" : row.sku ? "sku" : Object.keys(row)[0],
        primaryKeyValue: pk,
        updatedData: JSON.stringify(row)
      });

      if (res.success) {
        showMessage("✅ Row updated successfully");
      } else {
        showMessage("❌ Failed to update", true);
      }
    }

    function showMessage(msg, isError = false) {
      const m = document.getElementById("message");
      m.innerText = msg;
      m.className = "fixed bottom-4 right-4 p-3 rounded-2xl shadow " + 
                    (isError ? "bg-red-500 text-white" : "bg-green-500 text-white");
      m.style.display = "block";
      setTimeout(() => m.style.display = "none", 3000);
    }

    // load first sheet on start
    loadSheet(SHEETS[0], tabsEl.children[0]);
  </script>
</body>
</html>
