<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול נתונים - ח. סבן</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f0f0f5;
            color: #1c1c1e;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }

        .iphone-container {
            max-width: 450px;
            margin: auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .nav-bar {
            background: #f9f9f9;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
            padding: 0.5rem 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }

        .nav-item.active .icon {
            color: #3b82f6;
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        .nav-item.active .label {
            color: #3b82f6;
            font-weight: 600;
        }

        .page {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 20;
        }
        
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal.open .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .toast {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .toast.show {
            opacity: 1;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="iphone-container">
        
        <!-- Login Page -->
        <div id="login-page" class="page flex flex-col items-center justify-center p-6 bg-white rounded-lg">
            <div class="w-full max-w-sm text-center">
                <i class="fas fa-lock text-6xl text-blue-500 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ברוכים הבאים</h1>
                <p class="text-gray-500 mb-6">אנא התחבר כדי להמשיך</p>
                <div class="space-y-4">
                    <input id="phone-input" type="text" placeholder="מספר טלפון" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 text-right" dir="rtl">
                    <input id="password-input" type="password" placeholder="סיסמה" class="w-full p-3 rounded-lg border focus:ring-2 focus:ring-blue-500 text-right" dir="rtl">
                    <button id="login-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600 transition">התחבר</button>
                </div>
            </div>
        </div>

        <!-- Main App Content -->
        <div id="app-container" class="flex flex-col flex-1 hidden">
            
            <!-- Header -->
            <header class="header">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div id="user-avatar" class="w-12 h-12 rounded-full bg-blue-500 flex items-center justify-center text-white text-xl font-bold"></div>
                        <div class="mr-4">
                            <h1 id="user-name" class="text-xl font-bold"></h1>
                            <p id="user-greeting" class="text-sm text-gray-500"></p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <button id="lang-btn" class="text-gray-500 text-lg hover:text-gray-700 transition"><i class="fas fa-globe"></i></button>
                        <button id="settings-btn" class="text-gray-500 text-lg hover:text-gray-700 transition"><i class="fas fa-cog"></i></button>
                    </div>
                </div>
            </header>

            <!-- Page Container -->
            <main id="page-container" class="flex-1 overflow-y-auto p-4">
                
                <!-- Home Page -->
                <div id="home-page" class="page">
                    <div class="grid grid-cols-2 gap-4">
                        <button class="glass-card flex flex-col items-center text-center p-4" onclick="switchPage('order-page')">
                            <i class="fas fa-plus-circle text-4xl text-blue-500 mb-2"></i>
                            <span class="text-lg font-bold">הזמנה חדשה</span>
                        </button>
                        <button class="glass-card flex flex-col items-center text-center p-4" onclick="switchPage('container-page')">
                            <i class="fas fa-truck-container text-4xl text-green-500 mb-2"></i>
                            <span class="text-lg font-bold">מכולות</span>
                        </button>
                        <button class="glass-card flex flex-col items-center text-center p-4" onclick="switchPage('history-page')">
                            <i class="fas fa-history text-4xl text-yellow-500 mb-2"></i>
                            <span class="text-lg font-bold">היסטוריה</span>
                        </button>
                        <button class="glass-card flex flex-col items-center text-center p-4" onclick="switchPage('catalog-page')">
                            <i class="fas fa-boxes text-4xl text-red-500 mb-2"></i>
                            <span class="text-lg font-bold">קטלוג</span>
                        </button>
                    </div>
                    
                    <div class="mt-8 text-center">
                        <h2 class="text-xl font-bold mb-2">סטטוס הזמנות אחרונות</h2>
                        <div id="status-feed" class="space-y-4">
                            <!-- Order statuses will be dynamically injected here -->
                        </div>
                    </div>
                </div>
                
                <!-- Order Page -->
                <div id="order-page" class="page hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">הזמנה חדשה</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="order-address-input" class="block text-sm font-medium text-gray-700">כתובת משלוח</label>
                            <input type="text" id="order-address-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:ring-blue-500" placeholder="הכנס כתובת או בחר מהרשימה">
                        </div>
                        <div>
                            <label for="order-details-textarea" class="block text-sm font-medium text-gray-700">פרטי הזמנה</label>
                            <textarea id="order-details-textarea" rows="4" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:ring-blue-500" placeholder="דוגמה: 200 בלוקים, 5 שקי מלט..."></textarea>
                        </div>
                        <button id="send-order-btn" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fab fa-whatsapp ml-2"></i> שלח הזמנה בווטסאפ
                        </button>
                        <button id="add-example-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition-colors mt-2">
                             <i class="fas fa-list-ul ml-2"></i> הוסף הזמנת דוגמה לגיליון
                        </button>
                    </div>
                </div>

                <!-- History Page -->
                <div id="history-page" class="page hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">היסטוריית הזמנות</h2>
                    <div id="history-table-container">
                        <!-- Table will be dynamically inserted here -->
                    </div>
                    <div class="text-center mt-4 hidden" id="no-history-data">
                        <p class="text-gray-500">אין נתונים להצגה.</p>
                    </div>
                </div>
                
                <!-- Container Page -->
                <div id="container-page" class="page hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">ניהול מכולות</h2>
                    <div class="text-center mb-4">
                        <p class="text-gray-500">כאן תוכל להזמין או להחליף מכולות.</p>
                    </div>
                    <div id="container-cards-container" class="space-y-4">
                        <!-- Container cards will be dynamically inserted here -->
                    </div>
                    <div class="text-center mt-4 hidden" id="no-container-data">
                        <p class="text-gray-500">אין נתוני מכולות להצגה.</p>
                    </div>
                </div>

                <!-- Catalog Page -->
                <div id="catalog-page" class="page hidden">
                    <h2 class="text-2xl font-bold text-center mb-4">קטלוג מוצרים</h2>
                    <div id="catalog-grid" class="grid grid-cols-2 gap-4">
                        <!-- Catalog items will be dynamically inserted here -->
                    </div>
                    <div class="text-center mt-4 hidden" id="no-catalog-data">
                        <p class="text-gray-500">אין נתוני מוצרים בקטלוג.</p>
                    </div>
                </div>

            </main>

            <!-- Navigation Bar -->
            <nav class="nav-bar flex justify-around">
                <button class="nav-item flex flex-col items-center page-btn active" data-page="home-page">
                    <i class="fas fa-home icon text-xl text-gray-500"></i>
                    <span class="label text-xs text-gray-500 mt-1">בית</span>
                </button>
                <button class="nav-item flex flex-col items-center page-btn" data-page="order-page">
                    <i class="fas fa-plus-circle icon text-xl text-gray-500"></i>
                    <span class="label text-xs text-gray-500 mt-1">הזמנה</span>
                </button>
                <button class="nav-item flex flex-col items-center page-btn" data-page="container-page">
                    <i class="fas fa-truck-container icon text-xl text-gray-500"></i>
                    <span class="label text-xs text-gray-500 mt-1">מכולות</span>
                </button>
                <button class="nav-item flex flex-col items-center page-btn" data-page="catalog-page">
                    <i class="fas fa-boxes icon text-xl text-gray-500"></i>
                    <span class="label text-xs text-gray-500 mt-1">קטלוג</span>
                </button>
                <button class="nav-item flex flex-col items-center page-btn" data-page="history-page">
                    <i class="fas fa-history icon text-xl text-gray-500"></i>
                    <span class="label text-xs text-gray-500 mt-1">היסטוריה</span>
                </button>
            </nav>
        </div>

        <!-- Container Action Modal -->
        <div id="container-modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title" class="text-2xl font-bold mb-4"></h3>
                <p id="modal-message" class="mb-4 text-gray-600"></p>
                <div class="space-y-4">
                    <select id="modal-action-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:ring-blue-500">
                        <option value="הורדה">הורדה</option>
                        <option value="החלפה">החלפה</option>
                        <option value="העלאה">העלאה</option>
                    </select>
                    <textarea id="modal-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring focus:ring-blue-500" placeholder="הערות"></textarea>
                </div>
                <div class="flex justify-end mt-6 space-x-2 space-x-reverse">
                    <button id="modal-close-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">ביטול</button>
                    <button id="modal-send-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">שליחה</button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

    </div>

    <script>
        // Global Constants
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymFIE4MJ-A4KxnhMb_dRZsJ0sYvYuAKJ0zeIJxjwH0rz5KjMLG0Exl20-XMiQMBFGR/exec';

        // UI Elements
        const loginPage = document.getElementById('login-page');
        const appContainer = document.getElementById('app-container');
        const phoneInput = document.getElementById('phone-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const pageButtons = document.querySelectorAll('.page-btn');
        const pages = document.querySelectorAll('.page');
        const sendOrderBtn = document.getElementById('send-order-btn');
        const addExampleBtn = document.getElementById('add-example-btn');
        const containerModal = document.getElementById('container-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalSendBtn = document.getElementById('modal-send-btn');
        const toast = document.getElementById('toast');

        // State & Data
        let activePage = 'home-page';
        let currentUser = null;
        
        // --- Users Data - You can edit this section ---
        let customersData = {
            '0508860896': {
                name: 'חיים סבן',
                avatar: 'ח',
                lastLogin: '2023-11-20T10:00:00Z',
                password: '123'
            },
            '0501234567': {
                name: 'אבי לוי',
                avatar: 'א',
                lastLogin: '2023-11-21T09:30:00Z',
                password: '123'
            }
        };
        // --- End of User Data Section ---

        // --- Helper Functions ---
        async function fetchGoogleScript(action, params = {}) {
            const url = new URL(SCRIPT_URL);
            url.searchParams.append('action', action);
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    url.searchParams.append(key, params[key]);
                }
            }
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Fetch Error:', error);
                showToast('שגיאה בתקשורת עם השרת.');
                return { success: false, error: 'Network error or server unreachable.' };
            }
        }
        
        function showToast(message) {
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function switchPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            pageButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
            activePage = pageId;

            if (pageId === 'container-page') {
                fetchAndRenderContainers();
            } else if (pageId === 'catalog-page') {
                fetchAndRenderCatalog();
            } else if (pageId === 'history-page') {
                 fetchAndRenderHistory();
            }
        }

        function renderUser(user) {
            document.getElementById('user-name').textContent = `שלום, ${user.name}`;
            document.getElementById('user-avatar').textContent = user.avatar;
            const lastLogin = new Date(user.lastLogin);
            const now = new Date();
            const timeSinceLastLogin = Math.floor((now - lastLogin) / (1000 * 60 * 60 * 24));
            document.getElementById('user-greeting').textContent = `כניסה אחרונה לפני ${timeSinceLastLogin} ימים`;
        }

        // --- Page Logic ---
        function handleLogin() {
            const phone = phoneInput.value;
            const password = passwordInput.value;
            const user = customersData[phone];

            if (user && user.password === password) {
                currentUser = user;
                loginPage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                renderUser(currentUser);
                switchPage('home-page');
            } else {
                showToast('מספר טלפון או סיסמה שגויים');
            }
        }

        async function addNewOrder() {
            const address = document.getElementById('order-address-input').value;
            const details = document.getElementById('order-details-textarea').value;

            if (!address || !details) {
                showToast('אנא מלא את כל השדות');
                return;
            }

            // Create a WhatsApp message
            const whatsappMessage = `*הזמנה חדשה*\n\n` +
                                    `*לקוח*: ${currentUser.name}\n` +
                                    `*כתובת*: ${address}\n` +
                                    `*פרטים*:\n${details}`;
            
            // Open WhatsApp
            window.open(`https://wa.me/972508860896?text=${encodeURIComponent(whatsappMessage)}`, '_blank');
        }

        async function addExampleOrder() {
            const params = {
                customerName: 'דוגמה - שמשון',
                productName: '200 בלוקים',
                quantity: 200,
                date: new Date().toLocaleDateString('he-IL')
            };
            const response = await fetchGoogleScript('addOrder', params);
            if (response.success) {
                showToast('הזמנת דוגמה נשלחה בהצלחה לגיליון!');
            } else {
                showToast('שגיאה בשליחת ההזמנה.');
            }
        }
        
        async function fetchAndRenderContainers() {
            const containerGrid = document.getElementById('container-cards-container');
            const noDataMessage = document.getElementById('no-container-data');
            containerGrid.innerHTML = '';
            noDataMessage.classList.add('hidden');
            
            showToast('טוען נתוני מכולות...');
            const data = await fetchGoogleScript('getSheetData', { sheetName: 'מכולות' });
            
            if (data && data.data && data.data.length > 0) {
                const html = data.data.map(item => `
                    <div class="glass-card flex items-center p-4">
                        <div class="flex-1">
                            <h3 class="font-bold">מכולה #${item['מספר מכולה ירדה']}</h3>
                            <p class="text-sm text-gray-600">ימים חלפו: ${item['ימים שעברו']}</p>
                        </div>
                        <button class="bg-blue-500 text-white text-xs px-3 py-1 rounded-full hover:bg-blue-600 transition"
                                onclick="openContainerModal({ containerId: '${item['מספר מכולה ירדה']}', days: ${item['ימים שעברו']} })">
                            <i class="fas fa-edit ml-1"></i> פעולה
                        </button>
                    </div>
                `).join('');
                containerGrid.innerHTML = html;
            } else {
                noDataMessage.classList.remove('hidden');
            }
        }

        async function fetchAndRenderCatalog() {
            const catalogGrid = document.getElementById('catalog-grid');
            const noDataMessage = document.getElementById('no-catalog-data');
            catalogGrid.innerHTML = '';
            noDataMessage.classList.add('hidden');
            
            showToast('טוען קטלוג...');
            const data = await fetchGoogleScript('getSheetData', { sheetName: 'קטלוג מוצרים' });
            
            if (data && data.data && data.data.length > 0) {
                const html = data.data.map(item => `
                    <div class="glass-card flex flex-col items-center text-center p-4">
                        <img src="${item.image}" class="w-24 h-24 object-cover rounded-full mb-2" onerror="this.src='https://placehold.co/96x96/E0E5EC/6B7280?text=אין תמונה'">
                        <h4 class="font-bold text-lg">${item.title}</h4>
                        <p class="text-sm text-gray-600">${item.price}</p>
                        <p class="text-xs text-gray-500 mt-1">${item.description}</p>
                    </div>
                `).join('');
                catalogGrid.innerHTML = html;
            } else {
                noDataMessage.classList.remove('hidden');
            }
        }

        async function fetchAndRenderHistory() {
            const historyContainer = document.getElementById('history-table-container');
            const noDataMessage = document.getElementById('no-history-data');
            historyContainer.innerHTML = '';
            noDataMessage.classList.add('hidden');

            showToast('טוען היסטוריית הזמנות...');
            const data = await fetchGoogleScript('getSheetData', { sheetName: 'הזמנות' });

            if (data && data.data && data.data.length > 0) {
                const tableHtml = `
                    <div class="overflow-x-auto rounded-lg shadow">
                        <table class="min-w-full bg-white text-sm">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="py-2 px-4 border-b">תאריך</th>
                                    <th class="py-2 px-4 border-b">לקוח</th>
                                    <th class="py-2 px-4 border-b">מוצר</th>
                                    <th class="py-2 px-4 border-b">כמות</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.data.map(row => `
                                    <tr class="hover:bg-gray-100 border-b">
                                        <td class="py-2 px-4">${row.date || ''}</td>
                                        <td class="py-2 px-4">${row.customerName || ''}</td>
                                        <td class="py-2 px-4">${row.productName || ''}</td>
                                        <td class="py-2 px-4">${row.quantity || ''}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                historyContainer.innerHTML = tableHtml;
            } else {
                noDataMessage.classList.remove('hidden');
            }
        }
        
        function openContainerModal({ action = 'החלפה', containerId = null, days = null }) {
            document.getElementById('modal-title').textContent = `פעולה עבור מכולה ${containerId || ''}`;
            document.getElementById('modal-message').textContent = containerId ? `מכולה #${containerId} הותקנה לפני ${days} ימים. מה ברצונך לבצע?` : 'בחר את הפעולה הרצויה:';
            document.getElementById('modal-action-select').value = action;
            containerModal.classList.add('open');
        }

        function sendContainerRequest() {
            const action = document.getElementById('modal-action-select').value;
            const notes = document.getElementById('modal-notes').value;
            const whatsappMessage = `*בקשה למכולה*\n\n` +
                                    `*פעולה*: ${action}\n` +
                                    `*הערות*: ${notes}\n` +
                                    `*לקוח*: ${currentUser.name}`;
            window.open(`https://wa.me/972508860896?text=${encodeURIComponent(whatsappMessage)}`, '_blank');
            containerModal.classList.remove('open');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Page navigation
            pageButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchPage(btn.dataset.page);
                });
            });

            // Login listeners
            loginBtn.addEventListener('click', handleLogin);
            phoneInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Order page listeners
            sendOrderBtn.addEventListener('click', addNewOrder);
            addExampleBtn.addEventListener('click', addExampleOrder);

            // Container modal listeners
            modalCloseBtn.addEventListener('click', () => {
                containerModal.classList.remove('open');
            });
            modalSendBtn.addEventListener('click', sendContainerRequest);
        });
    </script>
</body>
</html>
